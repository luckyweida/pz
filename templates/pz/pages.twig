{% extends 'pz/layout.twig' %}

{% from "pz/html/nestableNav.twig" import nest as nest %}
{% set categories = db.active('PageCategory') %}
{% set cat = app.request.get('cat') or app.request.get('cat') is same as('0') ? app.request.get('cat') : categories.0.id %}

{% set pageRoot = db.data('Page')|nestablePges(cat) %}


{% block extraHead %}
    <link href="{{ getenv('CDN') }}/pz/css/nestable.css" rel="stylesheet">
{% endblock %}

{% block extraHeaderLeft %}
    <h2>Manage <label class="label label-warning-light">Pages</label></h2>
{% endblock %}

{% block content %}
    <div class="row">
        <div class="col-lg-12 max-1000">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <a href="">
                        <button class="btn btn-w-m btn-info">
                            <i class="fa fa-plus-circle"></i>&nbsp;&nbsp;Add New Page
                        </button>
                    </a>
                </div>

                <div class="ibox-content">
                    <div class="page-category">

                        {% for itm in categories %}
                            <input data-id="{{ itm.id }}" id="itm{{ itm.id }}" type="radio" name="category" {{ itm.id == cat ? 'checked="checked"' : '' }} />
                            <label data-id="{{ itm.id }}" for="itm{{ itm.id }}">
                                <div class="dd other content-{{ itm.id }}" data-id="{{ itm.id }}" >
                                    <div class="dd-empty"></div>
                                </div>
                                <div class="item-title">{{ itm.title }} <span class="number"></span></div>
                            </label>
                        {% endfor %}

                        <input data-id="0"  id="itm0" type="radio" name="category" {{ 0 == cat ? 'checked="checked"' : '' }} />
                        <label data-id="0" for="itm0">
                            <div class="other dd content--1" data-id="0" >
                                <div class="dd-empty"></div>
                            </div>
                            <div class="item-title">Uncategorised <span class="number"></span></div>
                        </label>
                    </div>

                    <div class="nestable-lists">
                        <div class="dd" id="nestable">
                            <ol class="dd-list">
                                {% for itm in pageRoot.children %}
                                    {{ nest(itm, 1) }}
                                {% endfor %}
                            </ol>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extraFooter %}
    <script type="text/javascript" src="{{ getenv('CDN') }}/pz/js/jquery.nestable.js"></script>
    {#<script src="https://cdnjs.cloudflare.com/ajax/libs/Nestable/2012-10-15/jquery.nestable.min.js"></script>#}
    <script>
        var _ajax;

        $(function() {
            //init
            $('#nestable').nestable({ group: 1 }).on('change', update);

            //...
            $('.other').nestable({ group: 1 });
            $(document).on('mouseout', '.other', function() {
                setTimeout(function() {
                    $.each($('.other'), function(key, value) {
                        if ($(value).children().length == 0) {
                            $(value).html('<div class="dd-empty"></div>');
                        }
                    });
                }, 1500);
            });

            $.each($('.dd-item'), function (idx, itm) {
                if ($(itm).hasClass('dd-collapsed')) {
                    $(itm).find('button[data-action="collapse"]').hide();
                    $(itm).find('button[data-action="expand"]').show();
                } else {
                    $(itm).find('button[data-action="collapse"]').show();
                    $(itm).find('button[data-action="expand"]').hide();
                }
            });

            //what?
            $(document).on('click', '.dd-empty', function() {
                $('#' + $(this).parent().attr('for')).click();
            });

            //category
            $(document).on('click', '[name=category]', function() {
                $('label.dd').css('cursor', 'wait');
                $('label.dd').attr('disabled', 'disabled');
                $('#nestable').html('Loading...');
                location.href = '?cat=' + $(this).data('id');
            });

            //closed
            $(document).on('click', '.dd-item button', function () {
                $.ajax({
                    type: 'GET',
                    url: '{{ path('pzAjaxPageClosed') }}',
                    data: 'id=' + $(this).parent().data('id') + '&closed=' + ($(this).parent().hasClass('dd-collapsed') ? 1 : 0) + '&cat={{ cat }}',
                    success : function(msg) {

                    }
                });
            });

            countCat();
        });


        function countCat() {
            $.ajax({
                type: 'GET',
                url: '{{ path('pzAjaxCatCount') }}',
                success : function(msg) {
                    var reuslt = msg;
                    $.each($('.other'), function(key, value) {
                        var count = reuslt['cat' + $(value).data('id')] ?  reuslt['cat' + $(value).data('id')] : 0;
                        $(value).parent().find('span.number').html('(' + count + ')');
                    });
                }
            });
        };

        function update() {
            if (_ajax) _ajax.abort();

            var ignoreMe = false;
            $.each($('.other'), function(key, value) {
                var items = $(value).nestable('serialize');
                if (items.length > 0) {
                    if ('{{ cat }}' != $(value).data('id')) {
                        $.ajax({
                            type: 'GET',
                            url: '{{ path('pzAjaxPageChange') }}',
                            data: 'oldCat={{ cat }}&newCat=' + $(value).data('id') + '&id=' + items[0].id,
                            success : function(msg) {
                                $(value).html('<div class="dd-empty"></div>');
                                countCat();
                            }
                        });
                        ignoreMe = true;
                    } else {
                        $(value).html('<div class="dd-empty"></div>');
                        $('#nestable').html('Loading...');
                        location.reload();
                    }
                }
            });

            if (!ignoreMe) {
                var root = {
                    id: 0,
                    children: $('#nestable').nestable('serialize'),
                }
                var data = toArray(root);

                _ajax = $.ajax({
                    type: 'GET',
                    url: '{{ path('pzAjaxPagesSort') }}',
                    data: 'cat={{ cat }}&data=' + encodeURIComponent(JSON.stringify(data)),
                    success : function(msg) {
                    }
                });
            }
        };

        function toArray(node) {
            var result = [];
            for (var idx in node.children) {
                var itm = node.children[idx];
                result.push({
                    id: itm.id,
                    parentId: node.id,
                    rank: idx,
                    cat: '{{ cat }}'
                });
                result = result.concat(toArray(itm));
            }
            return result;
        };
    </script>
{% endblock %}
